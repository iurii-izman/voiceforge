# Интеграция с календарём (roadmap 17)

Исследование: триггер «встреча началась» для listen/analyze и опциональное подтягивание метаданных встречи.

## Цель

- Автоматически запускать запись (`listen`) или анализ (`analyze`) в момент начала календарного события (встречи).
- Опционально: подставлять в контекст метаданные встречи (название, участники, описание) из календаря.

## Варианты провайдеров

| Провайдер | Протокол / API | Аутентификация | Примечания |
|-----------|----------------|----------------|------------|
| **CalDAV** | CalDAV (RFC 4791) | Логин/пароль или токен; хранить в keyring (например `voiceforge caldav_password` или отдельный ключ) | Nextcloud, Radicale, Apple Calendar, Synology — общий протокол |
| **Google Calendar** | Google Calendar API | OAuth2; refresh token в keyring | Нужна регистрация приложения в Google Cloud, согласие пользователя |
| **Локальные календари** | Evolution, GNOME Calendar | Зависит от бэкенда (Evolution Data Server, etc.) | Сложнее унифицировать; возможен доступ через D-Bus или файлы |

## Что нужно для реализации

1. **Выбор провайдера:** для первого инкремента разумно начать с одного (например CalDAV — один протокол для многих серверов).
2. **Аутентификация:** для CalDAV — URL календаря, логин, пароль (или токен); хранить в keyring (см. `keyring-keys-reference.md`). Для Google — OAuth2 client id/secret и refresh token в keyring.
3. **Опрос или push:** календари редко дают push-уведомления. Типичный подход — опрос по интервалу (например каждые 1–2 минуты): «есть ли событие, которое началось в последние N минут?».
4. **Маппинг «событие началось» → действие:** при обнаружении начала события — вызвать `voiceforge listen` (или через демон/D-Bus старт записи) или предложить пользователю запустить анализ. Уточнить в ADR: автоматический старт vs. уведомление с кнопкой «Записать».
5. **Метаданные встречи:** при наличии — передавать в LLM контекст (название, описание, участники) для улучшения саммари и action items.

## Ограничения

- Внешние зависимости: доступ к интернету для Google; для CalDAV — доступ к серверу (может быть локальный Radicale).
- Частота запросов: не превышать лимиты API (Google) и разумные пределы для CalDAV.
- Хранение токенов и паролей — только в keyring (сервис `voiceforge`), не в конфиге в открытом виде.

## Рекомендация

- Зафиксировать выбор решения (провайдер, способ опроса, автоматический старт или уведомление) в **ADR** перед реализацией.
- Первый инкремент: опрос CalDAV по интервалу (настраиваемый URL и ключи в keyring), при «событие началось» — запись в runbook с настройкой одного провайдера (например Nextcloud или Radicale), затем интеграция с демоном (флаг или подкоманда `voiceforge calendar watch` / интеграция в daemon).

**Реализовано (2026-02):** подкоманда `voiceforge calendar poll` — однократный опрос «события, начавшиеся за последние N минут»; ключи keyring: `caldav_url`, `caldav_username`, `caldav_password`. Зависимость: `uv sync --extra calendar`. Дальше: `calendar watch` (цикл опроса) и/или интеграция с демоном.

**D3 (#48):** контекст следующего события календаря в анализ. При `calendar_context_enabled: true` в конфиге (или `VOICEFORGE_CALENDAR_CONTEXT_ENABLED=true`) пайплайн `analyze` подставляет в контекст LLM строку вида «Next meeting: Название — start_iso — end_iso» (следующее событие в ближайшие 24 ч). Данные берутся из CalDAV (те же ключи keyring). Опция по умолчанию выключена.

## См. также

- [keyring-keys-reference.md](keyring-keys-reference.md) — имена ключей для новых учётных данных (caldav_url, caldav_password и т.д. при добавлении).
- [adr/README.md](../adr/README.md) — шаблон ADR для решения по календарю.
