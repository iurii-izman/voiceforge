# План реализации десктоп-приложения VoiceForge (Tauri) и альфа2

Документ для реализации **десктопного UI на Tauri** под **Fedora Atomic Cosmic** с минимальными зависимостями, точечной реализацией и выходом в **альфа2-релиз**.

---

## Контекст системы

- **ОС:** Fedora Atomic (иммутабельная), десктоп **COSMIC** (Rust-ориентированный).
- **Разработка:** в **toolbox** / distrobox; приложения — Flatpak или из репо.
- **Текущий бэкенд:** демон (`voiceforge daemon`) — PipeWire → STT → diarization → RAG → LLM; **D-Bus** `com.voiceforge.App`: Analyze(seconds, template), GetSessions, GetSessionDetail, GetSettings, GetAnalytics, Listen start/stop, GetStreamingTranscript, сигналы (ListenStateChanged, TranscriptUpdated, AnalysisDone, TranscriptChunk).
- **Web UI сегодня:** `voiceforge web` — отдельный HTTP-сервер, вызывает **пайплайн и БД напрямую** (не через D-Bus). Дублирует логику демона для браузера.

**Вывод:** Десктоп-приложение должно быть **единственным нативным UI**, работающим **только через D-Bus** с уже запущенным демоном. Браузерное UI — по желанию оставить только для сценариев «без Tauri» (удалённый доступ, быстрый тест); иначе убрать, чтобы не дублировать и не мешать.

---

## Блок 1 — Архитектура и выбор стека

**Цель:** зафиксировать архитектуру и минимизировать зависимости.

- **1.1** Десктоп = **Tauri 2** (Rust + системный WebView). На Linux — WebKitGTK, без Electron, малый размер бинарника (~сотни KB поверх WebView).
- **1.2** Единственный бэкенд для GUI — **демон**. Tauri-приложение только **D-Bus-клиент**: вызовы методов и подписка на сигналы. Никакого встроенного Python, никакого своего HTTP-сервера в приложении.
- **1.3** **Браузерное UI:** оставить `voiceforge web` как **опциональный** способ запуска UI (без сборки Tauri): сценарии «только CLI + браузер» или «удалённый доступ». В релизе альфа2 не рекламировать; при желании позже можно убрать. Не дублировать фичи: новые фичи сначала в Tauri (D-Bus), при необходимости — в web.
- **1.4** Зависимости Tauri: Rust toolchain, `webkit2gtk` (и зависимости для сборки). В Fedora Atomic — сборка внутри toolbox с установленными пакетами для разработки Tauri/GTK.

**Результат блока:** одностраничный ADR или раздел в доке: «Десктоп UI = Tauri + D-Bus; демон — единая точка истины».

---

## Блок 2 — Окружение и зависимости под Fedora Atomic Cosmic

**Цель:** гарантировать сборку и запуск на твоей системе.

- **2.1** Список системных пакетов для сборки Tauri на Fedora: `webkit2gtk-4.1-devel`, `gtk3-devel`, `libappindicator-gtk3-devel` (опционально, для трея), `openssl-devel`, компилятор Rust (`rustup` в toolbox). Оформить в `docs/runbooks/desktop-build-deps.md` или в README десктоп-приложения.
- **2.2** Проверка окружения: скрипт или команда «проверить, что всё установлено для `cargo tauri build`» (аналог doctor для десктопа). Можно добавить в `scripts/` или в `desktop/README.md`.
- **2.3** COSMIC: приложение не требует специфичных COSMIC API; достаточно стандартного D-Bus session и Wayland/Х11. Горячие клавиши — через настройки COSMIC (Custom Shortcuts, dbus-send), как уже описано в коде.

**Результат блока:** документ с зависимостями и шагами установки; один скрипт проверки окружения.

---

## Блок 3 — Каркас Tauri-приложения

**Цель:** создать минимальный проект и связать его с репо.

- **3.1** Создать поддиректорию **`desktop/`** в корне репо (или монорепо с `voiceforge` и `voiceforge-desktop`). В `desktop/` — проект Tauri 2 (например, `create-tauri-app` с шаблоном **vanilla** или **minimal** — без тяжёлого фреймворка, чтобы минимум зависимостей).
- **3.2** Одно главное окно: заголовок «VoiceForge», область контента. Размер по умолчанию разумный (например 900×700), возможность ресайза.
- **3.3** D-Bus из Rust: вызовы к `com.voiceforge.App` через крейт **zbus** (или **dbus**). Минимальный слой: Ping, GetSettings, GetSessions(limit). Парсинг envelope: `{"schema_version","ok","data"}` и при envelope `data.sessions` / `data.settings`.
- **3.4** При старте приложения: проверить, что демон доступен (Ping). Если нет — показать краткое сообщение «Запустите демон: voiceforge daemon» и кнопку «Повторить». Не падать, не запускать демон из приложения (минимальные зависимости, один источник правды).

**Результат блока:** запускаемое Tauri-приложение, которое пингует демон и выводит сырые данные GetSettings/GetSessions в UI (для отладки достаточно).

---

## Блок 4 — UI: экраны, навигация и практики современного GUI

**Цель:** продуманный, не перегруженный интерфейс в духе современных настольных приложений.

- **4.1** **Навигация:** боковая панель (или табы) с разделами: **Главная** (статус + быстрый анализ), **Сессии** (список + детали), **Затраты** (аналитика), **Настройки** (только чтение из GetSettings). Один экран виден в момент — без лишних модалок на первом этапе.
- **4.2** **Главная:** индикатор «Демон доступен»; кнопки «Старт/стоп записи» (Listen start/stop по D-Bus); блок «Анализ» — поле «последние N секунд» (например 30) и выбор шаблона (standup, one_on_one, …); кнопка «Запустить анализ». После вызова Analyze — подписка на сигнал AnalysisDone; при успехе — обновить список сессий и показать краткий результат (или ссылку «перейти в сессию»). Стриминг: опционально показывать GetStreamingTranscript по таймеру при включённой записи.
- **4.3** **Сессии:** список из GetSessions (id, дата/время, длительность); клик по строке — GetSessionDetail(id) и отображение: сегменты транскрипта, анализ (вопросы, ответы, рекомендации, action items). Кнопки «Экспорт Markdown» / «Экспорт PDF» — через D-Bus или отдельный Tauri command, вызывающий CLI `voiceforge export --id N --format md|pdf` (минимальная связка с Python только для экспорта, если не выносить экспорт в демон).
- **4.4** **Затраты:** данные GetAnalytics("7d") / GetAnalytics("30d"); отображение суммы, по дням, по моделям (если есть в ответе). Простые таблицы или компактные карточки.
- **4.5** **Настройки:** только чтение (GetSettings): model_size, default_llm, budget_limit_usd, smart_trigger, sample_rate, streaming_stt, pii_mode. Без редактирования в альфа2 — «настройки задаются через конфиг/переменные окружения».
- **4.6** **Практики GUI:** тёмная тема по умолчанию (как в текущем Web UI); учёт `prefers-color-scheme` или переключатель позже; понятные состояния кнопок (disabled при запросе, спиннер при Analyze); короткие сообщения об ошибках (из D-Bus envelope error.message); без лишнего декора — только нужные элементы для сценария «запись → анализ → просмотр сессий и экспорт».

**Результат блока:** все основные экраны реализованы, навигация и отображение данных через D-Bus работают.

---

## Блок 5 — Интеграция с демоном: D-Bus и сигналы

**Цель:** полное использование контракта D-Bus без дублирования логики.

- **5.1** Реализовать вызовы всех нужных методов с учётом **envelope** (VOICEFORGE_IPC_ENVELOPE=1 по умолчанию): разбор `data.sessions`, `data.session_detail`, `data.settings`, `data.analytics`; при ошибке — `error.code`, `error.message`.
- **5.2** Analyze(seconds, template): передавать template; после вызова — дождаться сигнала AnalysisDone(status); при status=="ok" обновить список сессий (TranscriptUpdated(0)) и при необходимости открыть последнюю сессию.
- **5.3** Подписка на сигналы: ListenStateChanged(is_listening) — обновлять кнопку Старт/стоп и индикатор; TranscriptUpdated(session_id) — обновлять список или деталь; TranscriptChunk(text, speaker, timestamp_ms, is_final) — при желании показывать живой транскрипт в реальном времени.
- **5.4** GetStreamingTranscript: при включённой записи опционально опрашивать раз в 1–2 с и выводить partial/finals в блоке «Стриминг» на главной.
- **5.5** Документировать контракт для фронта (какие методы, какие ключи в envelope) в `docs/runbooks/config-env-contract.md` или в `desktop/DBUS.md`, чтобы не гадать по коду.

**Результат блока:** стабильная работа с демоном, отображение живого состояния и результатов анализа.

---

## Блок 6 — Сборка, запуск и упаковка (alpha2)

**Цель:** воспроизводимая сборка и вариант поставки под твою систему.

- **6.1** Сборка в toolbox: `cd desktop && cargo tauri build`. Артефакты: бинарник и ресурсы в `target/release/bundle/` (или deb/appimage в зависимости от конфига Tauri).
- **6.2** Запуск в dev: `cargo tauri dev` — приложение подключается к уже запущенному демону на той же сессии D-Bus.
- **6.3** Для альфа2: собрать **AppImage** или **Flatpak** (Tauri 2 поддерживает оба). Flatpak предпочтителен для Fedora Atomic; манифест можно добавить в `desktop/flatpak/` или в репо. Минимальный runtime — freedesktop SDK + WebKit.
- **6.4** В корне репо: краткая инструкция в README или в `docs/runbooks/quickstart.md`: «Десктоп: собрать из `desktop/`, перед запуском — запустить `voiceforge daemon`».

**Результат блока:** стабильная сборка и один вариант дистрибуции (например Flatpak) для альфа2.

---

## Блок 7 — Альфа2-релиз: версия и объём

**Цель:** зафиксировать границы альфа2 и чеклист релиза.

- **7.1** Версия: **0.2.0a1** (или 0.1.0a2 — по твоей нумерации). Тег: `v0.2.0-alpha.1` или `v0.1.0-alpha.2`.
- **7.2** В альфа2 входит: текущий CLI + демон (без изменений контракта, кроме уже сделанных) + **десктоп-приложение Tauri** (главная, сессии, затраты, настройки только чтение, экспорт через CLI или демон при наличии). Браузерное UI — по желанию оставить в дереве, но не в фокусе релиза.
- **7.3** Чеклист перед тегом: тесты CLI и демона проходят; десктоп собирается; краткий сценарий «запуск демона → запуск Tauri → анализ → просмотр сессии» выполняется; CHANGELOG обновлён; версия в pyproject.toml и в Tauri (package version) согласована.
- **7.4** Документация: обновить roadmap (десктоп отмечен как реализованный для альфа2); в release runbook добавить шаг «сборка десктоп-приложения и, при наличии, Flatpak».

**Результат блока:** чёткие критерии альфа2 и обновлённые релиз-документы.

---

## Блок 8 — Дополнительно: качество и следующие шаги

**Цель:** заложить основу для поддержки и следующих итераций.

- **8.1** Тесты: e2e для десктопа опциональны в альфа2 (запуск окна, нажатие «Ping» или «GetSessions» с моком D-Bus сложнее). Достаточно ручной проверки и стабильного контракта D-Bus (существующие тесты контракта в репо).
- **8.2** Иконка и название приложения: единый бренд VoiceForge; иконка для окна и, при наличии, для трея.
- **8.3** После альфа2: при необходимости — перенос экспорта (Markdown/PDF) в демон (D-Bus метод ExportSession(id, format)), чтобы десктоп не вызывать CLI; системный трей с «Старт/стоп записи»; уведомления при завершении анализа (optional).

**Результат блока:** понятно, что в альфа2 обязательно, а что отложить на следующий релиз.

---

## Сводка по блокам

| Блок | Содержание | Результат |
|------|------------|-----------|
| 1 | Архитектура: Tauri + D-Bus, демон — единственный бэкенд; браузерное UI опционально | ADR/раздел в доке |
| 2 | Окружение Fedora Atomic Cosmic: пакеты, скрипт проверки | Документ + скрипт |
| 3 | Каркас Tauri: проект в `desktop/`, окно, Ping + GetSettings/GetSessions | Запускаемое приложение |
| 4 | UI: навигация, главная, сессии, затраты, настройки (чтение) | Все экраны работают |
| 5 | D-Bus: все методы + envelope, сигналы (ListenStateChanged, AnalysisDone, TranscriptChunk) | Полная интеграция с демоном |
| 6 | Сборка и упаковка: tauri build, Flatpak/AppImage | Релизный артефакт |
| 7 | Альфа2: версия 0.2.0a1 (или 0.1.0a2), чеклист, CHANGELOG, release runbook | Критерии и доки релиза |
| 8 | Качество: иконка, опциональные тесты, следующие шаги (экспорт в демон, трей) | План после альфа2 |

---

## Ответ на вопрос «браузерное UI — лишнее?»

- **Не обязательно лишнее:** его можно оставить как запасной вариант (без сборки Tauri, только Python + браузер). Тогда оно «мешает» только если дублировать в нём каждый новый сценарий.
- **Рекомендация:** десктоп (Tauri) считать **основным UI**; браузерное — **опциональным** и не расширять в альфа2. При желании позже можно удалить команду `voiceforge web`, чтобы уменьшить поверхность поддержки.

---

## Промпт для следующего чата (старт с блока 1–2)

```
Проект VoiceForge. Контекст: @docs/runbooks/agent-context.md. Приоритеты: docs/roadmap-priority.md. Эффективно и дёшево; keyring; Fedora Atomic/toolbox/uv.

Реализовать десктоп по плану: @docs/desktop-tauri-implementation-plan.md

Начать с блоков 1–2: зафиксировать архитектуру (Tauri + D-Bus, демон — единственный бэкенд; браузерное UI опционально), затем окружение под Fedora Atomic Cosmic (список пакетов, скрипт проверки). Дальше по плану — каркас Tauri (блок 3).
```
